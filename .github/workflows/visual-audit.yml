name: visual-audit

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: Run ID to audit (maps to TestResults/runs/<run_id>/visual-pack)
        required: true
        type: string
      baseline_dir:
        description: Baseline directory
        required: false
        default: artifacts/visual-baselines
        type: string
      candidate_dir:
        description: Candidate visual pack directory (optional override)
        required: false
        default: ""
        type: string

permissions:
  contents: read

jobs:
  compare-visual-pack:
    runs-on: windows-latest
    env:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve visual paths
        id: paths
        shell: pwsh
        env:
          RUN_ID_INPUT: ${{ github.event.inputs.run_id }}
          BASELINE_DIR_INPUT: ${{ github.event.inputs.baseline_dir }}
          CANDIDATE_DIR_INPUT: ${{ github.event.inputs.candidate_dir }}
        run: |
          $runId = $env:RUN_ID_INPUT
          if ([string]::IsNullOrWhiteSpace($runId) -or $runId -notmatch '^[A-Za-z0-9._-]+$') {
            throw "Invalid run_id input."
          }

          $candidateOverride = $env:CANDIDATE_DIR_INPUT
          if (-not [string]::IsNullOrWhiteSpace($candidateOverride) -and $candidateOverride -notmatch '^[A-Za-z0-9._:\\/\\-]+$') {
            throw "Invalid candidate_dir input."
          }

          if ([string]::IsNullOrWhiteSpace($candidateOverride)) {
            $candidate = "TestResults/runs/$runId/visual-pack"
          }
          else {
            $candidate = $candidateOverride
          }

          $baseline = $env:BASELINE_DIR_INPUT
          if ([string]::IsNullOrWhiteSpace($baseline) -or $baseline -notmatch '^[A-Za-z0-9._:\\/\\-]+$') {
            throw "Invalid baseline_dir input."
          }

          $output = "TestResults/runs/$runId/visual-pack/visual-compare.json"

          "baseline=$baseline" >> $env:GITHUB_OUTPUT
          "candidate=$candidate" >> $env:GITHUB_OUTPUT
          "output=$output" >> $env:GITHUB_OUTPUT

      - name: Compare visual pack
        shell: pwsh
        run: |
          pwsh ./tools/compare-visual-pack.ps1 `
            -BaselineDir "${{ steps.paths.outputs.baseline }}" `
            -CandidateDir "${{ steps.paths.outputs.candidate }}" `
            -OutputPath "${{ steps.paths.outputs.output }}"

      - name: Applitools availability note
        if: ${{ env.APPLITOOLS_API_KEY != '' }}
        shell: pwsh
        run: |
          Write-Output "APPLITOOLS_API_KEY is configured. Visual pack can be uploaded for external review."

      - name: Upload visual compare report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-compare
          path: |
            ${{ steps.paths.outputs.output }}
            ${{ steps.paths.outputs.candidate }}
