name: release-portable

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: Tag to publish (required for manual release publish).
        required: false
        type: string
      publish_release:
        description: Publish or update a GitHub Release.
        required: false
        default: false
        type: boolean
      prerelease:
        description: Mark manual release as prerelease.
        required: false
        default: true
        type: boolean
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  package:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore SwfocTrainer.sln

      - name: Build
        run: dotnet build SwfocTrainer.sln -c Release --no-restore

      - name: Package Portable Zip
        shell: pwsh
        run: ./tools/package-portable.ps1 -Configuration Release

      - name: Generate SHA256 checksum
        shell: pwsh
        run: |
          $zip = Resolve-Path "artifacts/SwfocTrainer-portable.zip"
          $hash = Get-FileHash -Path $zip -Algorithm SHA256
          $checksumFile = "artifacts/SwfocTrainer-portable.zip.sha256"
          "$($hash.Hash.ToLowerInvariant()) *SwfocTrainer-portable.zip" | Set-Content -Path $checksumFile -Encoding ascii

      - name: Upload Release Bundle Artifact
        uses: actions/upload-artifact@v4
        with:
          name: swfoc-trainer-release-bundle
          path: |
            artifacts/SwfocTrainer-portable.zip
            artifacts/SwfocTrainer-portable.zip.sha256

      - name: Publish GitHub Release
        if: ${{ startsWith(github.ref, 'refs/tags/v') || inputs.publish_release == true }}
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          MANUAL_TAG_NAME: ${{ inputs.tag_name }}
          MANUAL_PRERELEASE: ${{ inputs.prerelease }}
          GITHUB_REF_TYPE: ${{ github.ref_type }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          $tag = $env:GITHUB_REF_NAME
          if ($env:GITHUB_REF_TYPE -ne "tag") {
            $tag = $env:MANUAL_TAG_NAME
          }

          if ([string]::IsNullOrWhiteSpace($tag)) {
            throw "tag_name input is required when publish_release=true on workflow_dispatch."
          }

          if ($tag -notmatch '^v[0-9A-Za-z._-]+$') {
            throw "tag_name contains unsupported characters. Allowed pattern: ^v[0-9A-Za-z._-]+$"
          }

          $zipPath = (Resolve-Path "artifacts/SwfocTrainer-portable.zip").Path
          $checksumPath = (Resolve-Path "artifacts/SwfocTrainer-portable.zip.sha256").Path
          $notesSource = "docs/release-notes-template.md"
          if (-not (Test-Path -Path $notesSource)) {
            throw "Release notes template not found: $notesSource"
          }

          $notesPath = Join-Path $env:RUNNER_TEMP "release-notes.md"
          Copy-Item -Path $notesSource -Destination $notesPath -Force

          gh release view $tag *> $null
          if ($LASTEXITCODE -eq 0) {
            gh release upload $tag $zipPath $checksumPath --clobber
            exit 0
          }

          $args = @(
            "release", "create", $tag, $zipPath, $checksumPath,
            "--title", "SWFOC Trainer $tag",
            "--notes-file", $notesPath,
            "--verify-tag"
          )

          $manualPrerelease = $env:MANUAL_PRERELEASE -eq "true"
          if ($manualPrerelease -and $env:GITHUB_REF_TYPE -ne "tag") {
            $args += "--prerelease"
          }

          gh @args
