name: ci

on:
  push:
    branches:
      - main
      - "feature/**"
      - "fix/**"
      - "chore/**"
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-test:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Restore
        run: dotnet restore SwfocTrainer.sln

      - name: Build
        run: dotnet build SwfocTrainer.sln -c Release --no-restore

      - name: Test (deterministic suite)
        run: >
          dotnet test tests/SwfocTrainer.Tests/SwfocTrainer.Tests.csproj
          -c Release
          --no-build
          --logger "trx;LogFileName=tests.trx"
          --results-directory TestResults
          --filter "FullyQualifiedName!~SwfocTrainer.Tests.Profiles.Live&FullyQualifiedName!~RuntimeAttachSmokeTests"

      - name: Launch-context fixture smoke
        shell: pwsh
        run: |
          python tools/detect-launch-context.py --from-process-json tools/fixtures/launch_context_cases.json --profile-root profiles/default > launch_context_results.json
          if (!(Test-Path -Path launch_context_results.json)) {
            throw "launch-context smoke failed. launch_context_results.json was not generated."
          }

          $data = Get-Content -Raw -Path launch_context_results.json | ConvertFrom-Json
          $expected = @{
            "roe-steammod"     = @{ profileId = "roe_3447786229_swfoc"; reasonCode = "steammod_exact_roe" }
            "aotr-steammod"    = @{ profileId = "aotr_1397421866_swfoc"; reasonCode = "steammod_exact_aotr" }
            "roe-modpath"      = @{ profileId = "roe_3447786229_swfoc"; reasonCode = "modpath_hint_roe" }
            "aotr-modpath"     = @{ profileId = "aotr_1397421866_swfoc"; reasonCode = "modpath_hint_aotr" }
            "sweaw-base"       = @{ profileId = "base_sweaw"; reasonCode = "exe_target_sweaw" }
            "starwarsg-no-cmd" = @{ profileId = "base_swfoc"; reasonCode = "foc_safe_starwarsg_fallback" }
            "mixed-steammod-aotr-modpath-roe" = @{ profileId = "aotr_1397421866_swfoc"; reasonCode = "steammod_exact_aotr" }
            "mixed-steammod-roe-modpath-aotr" = @{ profileId = "roe_3447786229_swfoc"; reasonCode = "steammod_exact_roe" }
            "aotr-modpath-spaces" = @{ profileId = "aotr_1397421866_swfoc"; reasonCode = "modpath_hint_aotr" }
            "roe-modpath-order66" = @{ profileId = "roe_3447786229_swfoc"; reasonCode = "modpath_hint_roe" }
            "swfoc-base-no-mod" = @{ profileId = "base_swfoc"; reasonCode = "foc_safe_starwarsg_fallback" }
          }

          $seen = @{}
          foreach ($entry in ($data.results | Where-Object { $_ -ne $null })) {
            $name = $entry.input.name
            if ([string]::IsNullOrWhiteSpace($name)) {
              continue
            }

            $seen[$name] = @{
              profileId = $entry.profileRecommendation.profileId
              reasonCode = $entry.profileRecommendation.reasonCode
            }
          }

          $missing = New-Object System.Collections.Generic.List[string]
          $mismatched = New-Object System.Collections.Generic.List[string]
          foreach ($name in $expected.Keys) {
            if (-not $seen.ContainsKey($name)) {
              [void]$missing.Add($name)
              continue
            }

            $want = $expected[$name]
            $actual = $seen[$name]
            if ($actual.profileId -ne $want.profileId -or $actual.reasonCode -ne $want.reasonCode) {
              [void]$mismatched.Add("$name expected=$($want.profileId):$($want.reasonCode) actual=$($actual.profileId):$($actual.reasonCode)")
            }
          }

          if ($missing.Count -gt 0 -or $mismatched.Count -gt 0) {
            throw "launch-context smoke failed. missing=[$(($missing -join ', '))] mismatched=[$(($mismatched -join '; '))]"
          }

          Write-Output "launch-context smoke passed"

      - name: Repro-bundle schema smoke
        shell: pwsh
        run: |
          pwsh ./tools/validate-repro-bundle.ps1 -BundlePath tools/fixtures/repro_bundle_sample.json -SchemaPath tools/schemas/repro-bundle.schema.json -Strict

      - name: Save patch-pack schema smoke
        shell: pwsh
        run: |
          pwsh ./tools/validate-save-patch-pack.ps1 -PatchPackPath tools/fixtures/save_patch_pack_sample.json -SchemaPath tools/schemas/save-patch-pack.schema.json -Strict

      - name: Calibration artifact schema smoke
        shell: pwsh
        run: |
          pwsh ./tools/validate-calibration-artifact.ps1 -ArtifactPath tools/fixtures/calibration_artifact_sample.json -SchemaPath tools/schemas/calibration-artifact.schema.json -Strict

      - name: Support bundle manifest schema smoke
        shell: pwsh
        run: |
          pwsh ./tools/validate-support-bundle-manifest.ps1 -ManifestPath tools/fixtures/support_bundle_manifest_sample.json -SchemaPath tools/schemas/support-bundle-manifest.schema.json -Strict

      - name: Binary fingerprint schema smoke
        shell: pwsh
        run: |
          pwsh ./tools/validate-binary-fingerprint.ps1 -FingerprintPath tools/fixtures/binary_fingerprint_sample.json -SchemaPath tools/schemas/binary-fingerprint.schema.json -Strict

      - name: Signature pack schema smoke
        shell: pwsh
        run: |
          pwsh ./tools/validate-signature-pack.ps1 -SignaturePackPath tools/fixtures/signature_pack_sample.json -SchemaPath tools/schemas/signature-pack.schema.json -Strict

      - name: Effective data index export smoke
        shell: pwsh
        run: |
          pwsh ./tools/research/export-effective-data-index.ps1 -ProfileId base_swfoc -OutPath TestResults/index/base_swfoc_effective_index.json -Strict

      - name: Story flow graph export smoke
        shell: pwsh
        run: |
          pwsh ./tools/research/export-story-flow-graph.ps1 -ProfileId roe_3447786229_swfoc -OutPath TestResults/flow/roe_flow_graph.json -Strict

      - name: Offline lua harness smoke
        shell: pwsh
        run: |
          pwsh ./tools/lua-harness/run-lua-harness.ps1 -Strict

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults

      - name: Upload Launch Context Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: launch-context-results
          path: launch_context_results.json
