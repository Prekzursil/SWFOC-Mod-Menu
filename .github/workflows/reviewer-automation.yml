name: reviewer-automation

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - synchronize

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  request-reviewers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Request reviewers (or apply fallback)
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          $prNumberRaw = $env.PR_NUMBER
          if ([string]::IsNullOrWhiteSpace($prNumberRaw) -and
              -not [string]::IsNullOrWhiteSpace($env.GITHUB_EVENT_PATH) -and
              (Test-Path -LiteralPath $env.GITHUB_EVENT_PATH)) {
            $eventPayload = Get-Content -Raw -LiteralPath $env.GITHUB_EVENT_PATH | ConvertFrom-Json
            $prNumberRaw = [string]$eventPayload.pull_request.number
          }

          [int]$pullNumber = 0
          if (-not [int]::TryParse($prNumberRaw, [ref]$pullNumber)) {
            throw "Invalid pull request number: '$prNumberRaw'"
          }

          $result = pwsh ./tools/request-pr-reviewers.ps1 `
            -RepoOwner "${{ github.repository_owner }}" `
            -RepoName "${{ github.event.repository.name }}" `
            -PullNumber $pullNumber `
            -RosterPath config/reviewer-roster.json

          $result | Out-File -FilePath reviewer-automation-result.json -Encoding utf8
          Write-Output $result

      - name: Upload reviewer automation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reviewer-automation-result
          path: reviewer-automation-result.json
