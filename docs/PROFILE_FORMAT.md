# Profile Format

Each profile JSON maps to `TrainerProfile` in `SwfocTrainer.Core`.

## Required Top-Level Fields

- `id`
- `displayName`
- `exeTarget` (`Sweaw` or `Swfoc`)
- `signatureSets`
- `fallbackOffsets`
- `actions`
- `featureFlags`
- `catalogSources`
- `saveSchemaId`
- `helperModHooks`
- `metadata`
- `backendPreference` (`auto` | `extender` | `helper` | `memory`)
- `requiredCapabilities` (array of feature IDs required for mutation route promotion)
- `hostPreference` (`starwarsg_preferred` | `any`)
- `experimentalFeatures` (array of feature IDs shown as experimental in diagnostics)

## Signature Fields

Each signature entry supports:

- `name`
- `pattern`
- `offset`
- `valueType`
- `addressMode` (optional, defaults to `HitPlusOffset`)

`addressMode` values:

- `HitPlusOffset`: final address is `patternHit + offset`.
- `ReadAbsolute32AtOffset`: read a 32-bit absolute address at `patternHit + offset` and use it as the final address.
- `ReadRipRelative32AtOffset`: decode a signed 32-bit RIP-relative displacement at `patternHit + offset` and compute the final address relative to the end of the instruction.

## Inheritance Rules

Use `inherits` for layered profiles.

- Child profile values overwrite parent values for:
  - `actions`
  - `featureFlags`
  - `fallbackOffsets`
  - `metadata` keys
- List fields are concatenated:
  - `signatureSets`
  - `catalogSources`
  - `helperModHooks`

## Action Payloads

`payloadSchema.required` lists required JSON keys.

Runtime memory actions currently accept:

- `symbol` + `intValue`
- `symbol` + `floatValue`
- `symbol` + `boolValue`

Credits actions also support:

- `set_credits`: `lockCredits` (optional, default `false`)
- For FoC profiles, `set_credits` should use `executionKind: "Sdk"` so it is routed through extender capability gates.

Backward compatibility:

- `forcePatchHook` is accepted as an alias for `lockCredits`.

Helper actions should include `helperHookId`.

## Metadata Contract (Standardized)

The `metadata` object is string-keyed and string-valued. Runtime and tooling consume specific keys.

### Required for Mod Profiles

- `requiredWorkshopIds`
  - CSV of required workshop IDs.
  - Example: `"1397421866,3447786229"`
- `requiredMarkerFile`
  - Relative marker file path inside each dependency root.
  - Example: `"Data/XML/Gameobjectfiles.xml"`
- `dependencySensitiveActions`
  - CSV of action IDs to soft-disable when dependency verification is unresolved.

### Optional

- `localPathHints`
  - CSV tokens used to infer profile from `MODPATH`.
- `localParentPathHints`
  - CSV child folder hints used to discover parent dependencies from local mod roots.
- `profileAliases`
  - CSV aliases for profile identification in launch-context heuristics and tooling.
- `criticalSymbols`
  - CSV symbol IDs that require strict write reliability behavior.
  - Critical symbol writes trigger one re-resolve retry before final failure.
- `symbolValidationRules`
  - JSON array (encoded as string) of per-symbol sanity rules.
  - Fields:
    - `Symbol` (required)
    - `Mode` (optional: `Galactic`, `Tactical`, etc.)
    - `IntMin`, `IntMax` (optional integer bounds)
    - `FloatMin`, `FloatMax` (optional floating bounds)
    - `Critical` (optional bool)
  - Example value:
    - `"[{\"Symbol\":\"credits\",\"IntMin\":0,\"IntMax\":2000000000,\"Critical\":true}]"`
- `onboardingNotes`
  - Free-form notes captured by Mod Compatibility Studio when scaffolding a draft profile.

## Custom Namespace Convention (M3)

Draft custom-mod profiles generated by Mod Compatibility Studio are emitted under:

- `profiles/custom/profiles/<draftProfileId>.json` (default namespace)

`<draftProfileId>` is normalized to lowercase snake-case and prefixed with `custom_`.
Example:

- input draft id `My Total Conversion`
- output profile id `custom_my_total_conversion`

### Legacy Compatibility

- `requiredWorkshopId` (singular) is still accepted by runtime/tools for backward compatibility.
- New/updated profiles should use `requiredWorkshopIds`.

## LaunchContext Semantics

`ProcessMetadata` may include `LaunchContext` resolved from process detection + profile metadata hints.

### `LaunchKind`

- `Unknown`
- `BaseGame`
- `Workshop`
- `LocalModPath`
- `Mixed` (both workshop IDs and MODPATH markers present)

### `ProfileRecommendation`

- `ProfileId`: recommended profile ID, nullable.
- `ReasonCode`: stable reason token.
- `Confidence`: `0.0` to `1.0`.

Current reason codes:

- `steammod_exact_roe`
- `steammod_exact_aotr`
- `modpath_hint_roe`
- `modpath_hint_aotr`
- `exe_target_sweaw`
- `foc_safe_starwarsg_fallback`
- `unknown`

## Runtime Host Selection Diagnostics

`ProcessMetadata` and attach diagnostics now include deterministic host-ranking fields:

- `hostRole`
  - `launcher` / `game_host` / `unknown`
- `mainModuleSize`
  - integer module memory size in bytes
- `workshopMatchCount`
  - number of required workshop IDs matched for the selected profile
- `selectionScore`
  - numeric ranking score used to break candidate ties deterministically

For FoC profiles with `hostPreference=starwarsg_preferred`, host ranking prefers `StarWarsG.exe` over `swfoc.exe` when both are present.

## Universal Auto Profile (R&D)

- User-facing profile ID: `universal_auto`.
- Purpose: provide one default selection while resolving to concrete internal variants (`base_sweaw`, `base_swfoc`, `aotr_1397421866_swfoc`, `roe_3447786229_swfoc`).
- Resolution priority:
  - executable family (`sweaw` vs `swfoc`),
  - launch-context recommendation (workshop/modpath),
  - fingerprint map default profile,
  - safe fallback by exe target.

Runtime diagnostics metadata keys:

- `requestedProfileId`
- `resolvedVariant`
- `resolvedVariantReasonCode`
- `resolvedVariantConfidence`
- `resolvedVariantFingerprintId` (optional)
- `runtimeModeHint`
- `runtimeModeEffective`
- `runtimeModeReasonCode`

## SDK Capability Maps (R&D)

Capability maps are fingerprint-scoped contracts stored under:

- `profiles/default/sdk/maps/<fingerprintId>.json`

Generated research artifacts:

- `TestResults/research/<runId>/fingerprint.json`
- `TestResults/research/<runId>/signature-pack.json`
- `TestResults/research/<runId>/analysis-notes.md`

Validation commands:

```powershell
pwsh ./tools/validate-binary-fingerprint.ps1 -FingerprintPath tools/fixtures/binary_fingerprint_sample.json -SchemaPath tools/schemas/binary-fingerprint.schema.json -Strict
pwsh ./tools/validate-signature-pack.ps1 -SignaturePackPath tools/fixtures/signature_pack_sample.json -SchemaPath tools/schemas/signature-pack.schema.json -Strict
```

## Tooling Contract

`tools/detect-launch-context.py` uses this profile metadata contract directly (no hardcoded mapping table) and emits:

- `schemaVersion`
- `generatedAtUtc`
- `input`
- `launchContext`
- `profileRecommendation`
- `dependencyHints`

M3/M4 tooling schemas:

- calibration artifact: `tools/schemas/calibration-artifact.schema.json`
- support bundle manifest: `tools/schemas/support-bundle-manifest.schema.json`

## Save Patch-Pack Contract (M2)

Save Lab patch packs are schema-path JSON artifacts validated against:

- `tools/schemas/save-patch-pack.schema.json`

Top-level fields:

- `metadata`
  - `schemaVersion` (`1.0`)
  - `profileId`
  - `schemaId`
  - `sourceHash` (`sha256` lowercase hex)
  - `createdAtUtc` (UTC timestamp)
- `compatibility`
  - `allowedProfileIds` (array of profile IDs or wildcard `*`)
  - `requiredSchemaId`
  - `saveBuildHint` (optional)
- `operations`
  - `kind` (`SetValue` in v1)
  - `fieldPath`
  - `fieldId`
  - `valueType`
  - `oldValue` (optional in v1)
  - `newValue` (required in v1)
  - `offset`

V1 scope:

- typed field operations only (no raw byte patch payloads)
- strict atomic apply path with automatic backup + receipt
- strict-mode apply blocks source-hash mismatch (UI now exposes strict toggle, default ON).

## Spawn Preset Contract

Live Ops spawn presets are profile-scoped and optional.

- Path convention:
  - `profiles/default/presets/<profileId>/spawn_presets.json`
- JSON shape:
  - `schemaVersion` (string)
  - `presets` (array)
  - Each preset field:
    - `id` (string, unique per profile)
    - `name` (string)
    - `unitId` (string)
    - `faction` (string)
    - `entryMarker` (string)
    - `defaultQuantity` (int, optional, defaults to `1`)
    - `defaultDelayMs` (int, optional, defaults to `125`)
    - `description` (string, optional)

Behavior:

- If a preset file is missing, runtime tooling can generate fallback presets from catalog sources.
- Preset files are additive and do not change profile inheritance semantics.

## Action Reliability States

Live Ops surfaces action reliability as:

- `stable`
  - mode/dependency gates pass and symbol quality is healthy.
- `experimental`
  - action can run but uses degraded/fallback confidence paths.
- `unavailable`
  - strict mode gate fails, dependency blocks action, or required symbols are unresolved.

Diagnostics keys attached to action results/audit may include:

- `reliabilityState`
- `reliabilityReasonCode`
- `bundleGateResult`
- `transactionId` (for selected-unit transaction workflows)
