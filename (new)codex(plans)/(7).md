# AOTR Save-Driven Live Validation Plan (OCR Name Matching, ROE Deferred)

## Summary
Implement a decision-complete AOTR automation upgrade so you only need to start the run command and keep the game visible, while the pipeline loads your prepared saves by **name** and executes live checks with scoped evidence output.

Locked decisions applied:
1. Tactical target: run both `aotr_tactical_space` and `aotr_tactical_ground`.
2. Save selection strategy: name/OCR matching (not fixed slot index).
3. OCR engine: install and use Tesseract + Python.
4. Scope timing: AOTR now, ROE in next slice.
5. Existing FoC launch hardening remains in place (`direct_swfoc` first, `sweaw.exe` rejected).

Prepared save contract (AOTR):
1. Galactic helper state: `aotr_galactic_map`
2. Tactical space state: `aotr_tactical_space`
3. Tactical ground state: `aotr_tactical_ground`

## Current State (grounded)
1. `tools/run-live-validation-orchestrated.ps1` already exists and is parse-valid in `-ValidateOnly`.
2. Current macro flow still selects save via row coordinates, not save-name match.
3. Macro profile still uses placeholder save names (`AUTOTEST_AOTR`, `AUTOTEST_ROE`).
4. OCR dependencies are currently missing in environment (`tesseract`, `pytesseract` not installed).
5. FoC launch path now resolves correctly to `swfoc.exe`/`StarWarsG.exe` with AOTR marker, and not base `sweaw.exe`.

## Implementation Plan

### Phase 0 — Define AOTR Save Contract and Scope Model
1. Add explicit AOTR save-name inputs in orchestrator:
`-AotrGalacticSaveName`, `-AotrTacticalSpaceSaveName`, `-AotrTacticalGroundSaveName`.
2. Add AOTR-focused plan modes:
`AOTR_GALACTIC_ONLY`, `AOTR_TACTICAL_SPACE_ONLY`, `AOTR_TACTICAL_GROUND_ONLY`, `AOTR_FULL`.
3. Keep existing modes backward compatible.
4. Default `AOTR_FULL` sequence:
launch FoC AOTR -> load `aotr_galactic_map` -> run AOTR helper scope -> load `aotr_tactical_space` -> tactical scope -> load `aotr_tactical_ground` -> tactical scope again.

Exit gate:
- Orchestrator accepts and reports these save names in summary config for every run.

### Phase 1 — OCR Dependency Bootstrap (Windows-only)
1. Add `tools/setup-live-ocr.ps1`:
- detects Python and pip,
- installs Python packages (`pytesseract`, `Pillow`),
- installs Tesseract via `winget` with ordered package-id attempts,
- verifies OCR binary path and language availability.
2. Add `tools/macros/requirements-ocr.txt`.
3. Add `tools/doctor-live-automation.ps1` for preflight checks:
- `AutoHotkey v2`,
- Tesseract executable reachable,
- Python module imports,
- game window mode preconditions.

Exit gate:
- `setup-live-ocr.ps1` finishes with explicit `ok` status or actionable failure code.
- `doctor-live-automation.ps1` prints pass/fail per dependency.

### Phase 2 — Name/OCR Save Resolver
1. Add `tools/macros/resolve-save-slot.py`:
- input: screenshot region, target save name, expected UI profile, threshold.
- output JSON: `found`, `targetName`, `matchedText`, `confidence`, `x`, `y`, `lineIndex`, `reasonCode`.
2. OCR algorithm (deterministic contract):
- crop load-list region from profile config,
- run `pytesseract.image_to_data`,
- reconstruct per-line text,
- normalize names (`lowercase`, keep `[a-z0-9_]`),
- exact match preferred, similarity fallback via `difflib`,
- confidence score with threshold default `0.78`.
3. Failure behavior:
- return explicit reason codes: `not_found`, `low_confidence`, `ocr_runtime_error`, `region_invalid`.

Exit gate:
- Given fixture screenshots, resolver returns correct coordinates for all three AOTR names.

### Phase 3 — Macro and Orchestrator Integration
1. Split macro flow into deterministic commands:
- `open_load_menu`
- `click_resolved_save_and_load`
- `enter_tactical_after_load` (used when tactical save loaded and tactical action needed)
2. Keep focus/bounds guard exactly as strict as now (`StarWarsG.exe`, borderless 1920x1080).
3. Orchestrator per scope step:
- launch/validate marker contract,
- macro opens load menu,
- capture list screenshot,
- OCR resolve target save by name,
- macro clicks resolved coordinate and confirms load,
- execute scope test.
4. Add degraded-mode option:
`-AllowManualResolveFallback` (default `false` for strict automation runs).
5. If OCR fails and fallback disabled, abort scope with explicit error and still emit artifacts.

Exit gate:
- Orchestrated run can load each AOTR save by name without relying on static save row indexes.

### Phase 4 — Evidence and Schema Extensions
1. Extend `orchestrated-summary.json`:
- include `saveResolution` object per stage (`targetName`, `matchedText`, `confidence`, `reasonCode`).
2. Extend `orchestrated-attempts.json`:
- include `saveName`, `variant` (`galactic`, `tactical_space`, `tactical_ground`).
3. Extend `macro-status-<step>.json`:
- include `targetSaveName` and final click coordinates used.
4. Update issue templates:
- `issue-34-ready.md` and `issue-19-ready.md` include save-resolution evidence rows.

Exit gate:
- Every run produces machine-readable save-resolution evidence, including failures.

### Phase 5 — Docs and Operator Workflow
1. Update `docs/LIVE_VALIDATION_RUNBOOK.md`:
- one-command AOTR flow,
- OCR setup,
- troubleshooting matrix for OCR mismatch and focus loss.
2. Update `docs/TEST_PLAN.md`:
- deterministic OCR fixture checks,
- AOTR full scripted flow acceptance checklist.
3. Update `TODO.md`:
- replace generic AOTR notes with named-save automation checklist.

Exit gate:
- Operator workflow is unambiguous: install OCR once, run one command, review artifacts.

## Important Changes or Additions to Public APIs / Interfaces / Types
1. CLI contract additions in `tools/run-live-validation-orchestrated.ps1`:
- `-Plan` new values (`AOTR_GALACTIC_ONLY`, `AOTR_TACTICAL_SPACE_ONLY`, `AOTR_TACTICAL_GROUND_ONLY`, `AOTR_FULL`)
- `-AotrGalacticSaveName`
- `-AotrTacticalSpaceSaveName`
- `-AotrTacticalGroundSaveName`
- `-AllowManualResolveFallback`
- `-OcrConfidenceThreshold`
2. New tooling interface:
- `tools/macros/resolve-save-slot.py` JSON I/O contract.
3. Macro profile schema changes in `tools/macros/profiles/borderless_1920x1080.en-US.json`:
- `preparedSaves.aotrGalactic`
- `preparedSaves.aotrTacticalSpace`
- `preparedSaves.aotrTacticalGround`
- `ocrRegions.loadList`
4. Artifact schema extension:
- `orchestrated-summary.json` per-stage `saveResolution`.
- `macro-status-<step>.json` adds `targetSaveName`, `resolvedClick`.

## Test Cases and Scenarios
1. Dependency bootstrap:
- `setup-live-ocr.ps1` installs and verifies OCR stack on Windows.
2. Deterministic OCR fixture tests:
- `aotr_galactic_map` resolves from fixture screenshot.
- `aotr_tactical_space` resolves from fixture screenshot.
- `aotr_tactical_ground` resolves from fixture screenshot.
3. Orchestrator non-live validation:
- `-ValidateOnly` passes script load and schema checks.
4. AOTR live galactic:
- AOTR launch markers valid.
- `aotr_galactic_map` loaded by OCR name match.
- helper workflow attaches `aotr_1397421866_swfoc`.
5. AOTR live tactical space:
- `aotr_tactical_space` loaded by OCR name match.
- tactical workflow executes without non-tactical skip.
6. AOTR live tactical ground:
- `aotr_tactical_ground` loaded by OCR name match.
- tactical workflow executes without non-tactical skip.
7. Failure safety:
- OCR not found => explicit `ocr_runtime_error`, run aborts with artifacts.
- low confidence => explicit `low_confidence`, no false success.
- focus/bounds change => macro abort with explicit reason.
8. Evidence readiness:
- `issue-34-ready.md` and `issue-19-ready.md` include both tactical variants and save-resolution lines.

## Explicit Assumptions and Defaults
1. Windows runtime target only.
2. Game UI is English and borderless 1920x1080.
3. AOTR save names are exact and remain available:
`aotr_galactic_map`, `aotr_tactical_space`, `aotr_tactical_ground`.
4. Tesseract install is allowed on machine.
5. ROE automation is intentionally deferred to next slice.
6. Safe-method boundary unchanged; this is tooling/orchestration only.
